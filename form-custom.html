<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formular Custom - Generator Documente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .filled-content {
            color: #0066cc;
            font-weight: 500;
            background-color: #eff6ff;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #93c5fd;
            display: inline-block;
            margin: 0 2px;
        }
        
        .empty-placeholder {
            color: #dc2626;
            font-weight: 500;
            background-color: #fef2f2;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #fca5a5;
            display: inline-block;
            margin: 0 2px;
        }
        
        .preview-content {
            max-height: 70vh;
            overflow-y: auto;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .form-section {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .field-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            text-transform: capitalize;
        }
        
        .field-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .field-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 id="pageTitle" class="text-2xl font-bold text-gray-900 mb-1">Formular Custom</h1>
                <p class="text-gray-600">Completează câmpurile pentru a genera documentul</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="goBack()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                    ← Înapoi
                </button>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6">
            <!-- Form Section -->
            <div class="form-section">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Completează Datele</h2>
                
                <!-- Loading indicator -->
                <div id="loadingForm" class="text-center py-8">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Se încarcă template-ul...</p>
                </div>

                <!-- Dynamic form will be generated here -->
                <form id="customForm" class="space-y-4 hidden">
                    <!-- Dynamic fields will be inserted here -->
                </form>

                <!-- Action buttons -->
                <div id="actionButtons" class="flex space-x-3 mt-6 hidden">
                    <button type="button" onclick="generatePreview()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        Generează Preview
                    </button>
                    <button type="button" onclick="generateDocument()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Generează Document
                    </button>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="form-section">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Preview Document</h2>
                
                <div id="previewContent" class="preview-content">
                    <div class="text-center py-12 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3 class="text-lg font-medium mb-2">Fără Preview</h3>
                        <p>Completează câmpurile și apasă "Generează Preview"</p>
                    </div>
                </div>
                
                <!-- Preview loading indicator -->
                <div id="previewLoading" class="text-center py-8 hidden">
                    <div class="loading mx-auto mb-4"></div>
                    <p class="text-gray-600">Se generează preview-ul...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        let currentTemplate = null;

        async function loadTemplate() {
            try {
                // Get template ID from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const templateId = urlParams.get('template');
                
                if (!templateId) {
                    alert('Template ID nu a fost găsit');
                    goBack();
                    return;
                }

                // Load template data
                currentTemplate = await ipcRenderer.invoke('get-custom-template', templateId);
                
                if (!currentTemplate) {
                    alert('Template-ul nu a fost găsit');
                    goBack();
                    return;
                }

                // Update page title
                document.getElementById('pageTitle').textContent = `Formular: ${currentTemplate.name}`;

                // Generate form fields
                generateForm(currentTemplate);
                
                // Hide loading and show form
                document.getElementById('loadingForm').classList.add('hidden');
                document.getElementById('customForm').classList.remove('hidden');
                document.getElementById('actionButtons').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading template:', error);
                alert('Eroare la încărcarea template-ului');
                goBack();
            }
        }

        function generateForm(template) {
            const form = document.getElementById('customForm');
            form.innerHTML = '';

            let fieldsToProcess = [];
            
            // Use fieldConfigs if available, otherwise fallback to placeholders
            if (template.fieldConfigs && template.fieldConfigs.length > 0) {
                fieldsToProcess = template.fieldConfigs.sort((a, b) => a.order - b.order);
            } else {
                // Backward compatibility
                fieldsToProcess = template.placeholders.map(placeholder => ({
                    placeholder: placeholder,
                    fieldId: placeholder.replace(/[\[\]]/g, ''),
                    type: 'text',
                    label: formatFieldLabel(placeholder.replace(/[\[\]]/g, '').toLowerCase()),
                    order: template.placeholders.indexOf(placeholder)
                }));
            }

            fieldsToProcess.forEach(config => {
                const fieldDiv = document.createElement('div');
                const fieldId = config.fieldId.toLowerCase();
                let fieldHTML = '';
                
                switch(config.type) {
                    case 'textarea':
                        const rows = config.rows || 4;
                        fieldHTML = `
                            <label for="${fieldId}" class="field-label">${config.label}</label>
                            <textarea 
                                id="${fieldId}" 
                                name="${fieldId}" 
                                rows="${rows}"
                                class="field-input"
                                placeholder="Introdu ${config.label.toLowerCase()}"
                                onchange="handleFieldChange()"
                            ></textarea>
                        `;
                        break;
                        
                    case 'dropdown':
                        const options = config.options || [];
                        const optionsHTML = options.map(option => 
                            `<option value="${option}">${option}</option>`
                        ).join('');
                        
                        fieldHTML = `
                            <label for="${fieldId}" class="field-label">${config.label}</label>
                            <select 
                                id="${fieldId}" 
                                name="${fieldId}" 
                                class="field-input"
                                onchange="handleFieldChange()"
                            >
                                <option value="">Selectează ${config.label.toLowerCase()}</option>
                                ${optionsHTML}
                            </select>
                        `;
                        break;
                        
                    case 'checkbox':
                        fieldHTML = `
                            <div class="flex items-center space-x-3">
                                <input 
                                    type="checkbox" 
                                    id="${fieldId}" 
                                    name="${fieldId}" 
                                    class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                                    onchange="handleFieldChange()"
                                />
                                <label for="${fieldId}" class="field-label mb-0">${config.label}</label>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                ${config.checkedText ? `Bifat: "${config.checkedText}" | Nebifat: "${config.uncheckedText}"` : ''}
                            </p>
                        `;
                        break;
                        
                    case 'gender':
                        fieldHTML = `
                            <label for="${fieldId}" class="field-label">${config.label}</label>
                            <select 
                                id="${fieldId}" 
                                name="${fieldId}" 
                                class="field-input"
                                onchange="handleFieldChange()"
                            >
                                <option value="">Selectează genul</option>
                                <option value="male">Masculin${config.maleText ? ` - "${config.maleText}"` : ''}</option>
                                <option value="female">Feminin${config.femaleText ? ` - "${config.femaleText}"` : ''}</option>
                            </select>
                        `;
                        break;
                        
                    case 'text':
                    default:
                        fieldHTML = `
                            <label for="${fieldId}" class="field-label">${config.label}</label>
                            <input 
                                type="text" 
                                id="${fieldId}" 
                                name="${fieldId}" 
                                class="field-input"
                                placeholder="Introdu ${config.label.toLowerCase()}"
                                onchange="handleFieldChange()"
                            />
                        `;
                        break;
                }
                
                fieldHTML += `<p class="text-xs text-gray-500 mt-1">Placeholder: ${config.placeholder}</p>`;
                fieldDiv.innerHTML = fieldHTML;
                form.appendChild(fieldDiv);
            });
        }

        function formatFieldLabel(fieldName) {
            return fieldName
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function handleFieldChange() {
            // Auto-generate preview when fields change (with debounce)
            clearTimeout(window.previewTimeout);
            window.previewTimeout = setTimeout(() => {
                generatePreview();
            }, 1000);
        }

        async function generatePreview() {
            const formData = getFormData();
            const previewContent = document.getElementById('previewContent');
            const previewLoading = document.getElementById('previewLoading');
            
            try {
                previewContent.classList.add('hidden');
                previewLoading.classList.remove('hidden');
                
                // For custom templates, we need to implement preview functionality
                // This would require extending the getPreview method to handle custom templates
                const result = await ipcRenderer.invoke('generate-custom-preview', currentTemplate.id, formData);
                
                if (result.success) {
                    previewContent.innerHTML = result.html;
                } else {
                    previewContent.innerHTML = `
                        <div class="text-center py-8 text-red-600">
                            <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h3 class="text-lg font-medium mb-2">Eroare Preview</h3>
                            <p>${result.error}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Preview error:', error);
                previewContent.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h3 class="text-lg font-medium mb-2">Eroare Preview</h3>
                        <p>Nu s-a putut genera preview-ul</p>
                    </div>
                `;
            } finally {
                previewLoading.classList.add('hidden');
                previewContent.classList.remove('hidden');
            }
        }

        async function generateDocument() {
            const formData = getFormData();
            
            try {
                // Show loading on generate button
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<div class="loading mr-2"></div> Se generează...';
                button.disabled = true;
                
                const result = await ipcRenderer.invoke('generate-custom-document', currentTemplate.id, formData);
                
                if (result.success) {
                    const openResult = await ipcRenderer.invoke('show-message-box', {
                        type: 'question',
                        title: 'Document generat',
                        message: `Documentul "${result.fileName}" a fost generat cu succes!`,
                        detail: `Template: ${result.templateName}`,
                        buttons: ['Deschide Document', 'OK'],
                        defaultId: 0
                    });
                    
                    if (openResult.response === 0) {
                        await ipcRenderer.invoke('open-file', result.filePath);
                    }
                } else {
                    await ipcRenderer.invoke('show-message-box', {
                        type: 'error',
                        title: 'Eroare',
                        message: 'Nu s-a putut genera documentul',
                        detail: result.error
                    });
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                await ipcRenderer.invoke('show-message-box', {
                    type: 'error',
                    title: 'Eroare',
                    message: 'Eroare la generarea documentului',
                    detail: error.message
                });
            } finally {
                // Restore button
                const button = document.querySelector('button[onclick="generateDocument()"]');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function getFormData() {
            const formData = {};
            const form = document.getElementById('customForm');
            
            // Get all input elements (text, checkbox)
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    formData[input.name] = input.checked.toString();
                } else {
                    formData[input.name] = input.value;
                }
            });
            
            // Get all select elements (dropdown, gender)
            const selects = form.querySelectorAll('select');
            selects.forEach(select => {
                formData[select.name] = select.value;
            });
            
            // Get all textarea elements
            const textareas = form.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                formData[textarea.name] = textarea.value;
            });
            
            return formData;
        }

        function goBack() {
            window.location.href = 'template-manager.html';
        }

        // Load template when page loads
        document.addEventListener('DOMContentLoaded', loadTemplate);
    </script>
</body>
</html>